#!/usr/bin/env bash
set -eEuo pipefail

_arg_verbose=1

debug() { if (( _arg_verbose >= 3 )); then printf '[DEBUG] %s\n' "$*" >&2; fi; }
log()   { if (( _arg_verbose >= 2 )); then printf '%s\n' "$*" >&2; fi; }
warn()  { if (( _arg_verbose >= 1 )); then printf '[WARN] %s\n' "$*" >&2; fi; }
error() { printf '[ERROR] %s\n' "$*" >&2; }
is_on() { [[ "$1" == "on" ]]; }

die() {
    local _ret="${2:-1}"
    if is_on "${_PRINT_HELP:-no}" && (( _arg_verbose > 0 )); then print_help >&2; fi
    error "$1"
    exit "$_ret"
}

trap 'die "Error (exit $?): ${BASH_SOURCE[1]}:${BASH_LINENO[0]} in ${FUNCNAME[1]-main}" $?' ERR

print_help() {
    cat <<'USAGE'
Output publishable markdown files in given directory
Usage: get-files-to-publish [--ignore-publish-state] [-m|--missing-alias <arg>] [-0|--print0] [-h|--help] [-v|--verbose <level>] <directory>

Arguments:
    <directory>: Directory containing the markdown files
    --ignore-publish-state                      Ignore 'publish' option in front-matter (default: false)
    -m, --missing-alias                         Check for 'aliases' option if 'slug' or 'url' is set in file front-matter ('ignore', 'warn' or 'error'. Default: 'ignore')
    -0, --print0                                Separate output filenames with null character (for use when piping to other commands)
    -v, --verbose <level>                       Set verbosity level (0 or 'quiet', 1 or 'normal' (default), 2 or 'verbose', 3 or 'debug')
    -h, --help                                  Display this help message and exit.

Examples:
    get-files-to-publish ./content/posts
    get-files-to-publish -p ./content/posts
    get-files-to-publish --only-published --missing-alias warn ./content/posts

Dependencies:
    - is-file-publishable
    - realpath
    - find
    - sed
    - Bash version 4.3 or higher

Error codes:
    1: Invalid command line arguments
    2: is-file-publishable command not found
    3: Required command not found (realpath, find, readarray, sed)
    4: Invalid or missing directory argument
    5: Missing or invalid aliases in front-matter
    6: No markdown files
    99: Unexpected error

Implementation notes:
    - Multiple markdown extensions supported via _markdown_extensions array
    - Directory argument is normalized to always end with a slash for alias matching
    - Alias matching strips extension for all supported markdown extensions
    - All required commands are checked before execution
USAGE
}

# DEFAULTS INITIALIZATION
_arg_ignore_publish_state="off"
_arg_missing_alias="ignore"
_arg_print0="off"
_arg_directory=""
_markdown_extensions=("md")


parse_commandline() {
    local _key
    local -a _positionals=()
    while [[ $# -gt 0 ]]; do
        _key="$1"
        case "$_key" in
        --ignore-publish-state)
            _arg_ignore_publish_state="on"
            shift
            ;;
        -m | --missing-alias)
            shift
            if [[ $# -lt 1 ]]; then
                _PRINT_HELP="on" die "--missing-alias requires a value." 1
            fi
            _arg_missing_alias="$1"
            shift
            ;;
        --missing-alias=*)
            _arg_missing_alias="${_key##--missing-alias=}"
            shift
            ;;
        -0 | --print0)
            _arg_print0="on"
            shift
            ;;
        -h | --help)
            print_help
            exit 0
            ;;
        -v | --verbose)
            shift
            if [[ $# -lt 1 ]]; then
                _PRINT_HELP="on" die "--verbose requires a value." 1
            fi
            case "$1" in
            0 | quiet) _arg_verbose=0 ;;
            1 | normal) _arg_verbose=1 ;;
            2 | verbose) _arg_verbose=2 ;;
            3 | debug) _arg_verbose=3 ;;
            *)
                _PRINT_HELP="on" die "Invalid value for --verbose: '$1'. Must be one of: 0 or 'quiet', 1 or 'normal', 2 or 'verbose', 3 or 'debug'." 1
                ;;
            esac
            shift
            ;;
        --) # end of options
            shift
            while [[ $# -gt 0 ]]; do
                _positionals+=("$1")
                shift
            done
            ;;
        -*) # Unknown option
                _PRINT_HELP="on" die "Unknown option '$1'." 1
                ;;
        *)
            _positionals+=("$1")
            shift
            ;;
        esac
    done

    local -r _positionals_count=${#_positionals[@]}
    if [[ "${_positionals_count}" -lt 1 ]]; then
        _PRINT_HELP="on" die "One positional argument (directory) is required." 1
    fi
    if [[ "${_positionals_count}" -gt 1 ]]; then
        _PRINT_HELP="on" die "Too many positional arguments provided (expected 1, got $_positionals_count)." 1
    fi

    _arg_directory="${_positionals[0]}"
}

check_dependencies() {
    if ! command -v is-file-publishable &>/dev/null; then
        die "Error: Could not find is-file-publishable in PATH." 2
    fi
    if ! command -v realpath &>/dev/null; then
        die "Error: Could not find realpath in PATH." 3
    fi
    if ! command -v find &>/dev/null; then
        die "Error: Could not find find in PATH." 3
    fi
    if ! command -v sed &>/dev/null; then
        die "Error: Could not find sed in PATH." 3
    fi

    if (( BASH_VERSINFO[0] < 4 || ( BASH_VERSINFO[0] == 4 && BASH_VERSINFO[1] < 3 ) )); then
        die "Bash version 4.3 or higher is required. Current version is ${BASH_VERSION}." 3
    fi
}

validate_arguments() {
    [[ -z "$_arg_directory" ]] && die "Error: No source directory specified." 4
    if [[ ! -d "$_arg_directory" ]]; then
        die "Source directory '$_arg_directory' does not exist." 4
    fi
    _arg_directory="${_arg_directory%/}/" # Normalize directory path to always end with a slash for alias matching

    case "$_arg_missing_alias" in
    ignore | warn | error) ;;
    *)
        _PRINT_HELP="on" die "Invalid value for --missing-alias: '$_arg_missing_alias'. Must be one of: 'ignore', 'warn', 'error'." 1
        ;;
    esac

    # Internal errors
    case "$_arg_ignore_publish_state" in
        on | off) ;;
        *) die "Internal error: Invalid value for --only-published: '$_arg_ignore_publish_state'. Allowed values are 'on' or 'off'." 1 ;;
    esac
    case "$_arg_print0" in
        on | off) ;;
        *) die "Internal error: Invalid value for --print0: '$_arg_print0'. Allowed values are 'on' or 'off'." 1 ;;
    esac
}

main() {
    # Validation and parsing
    check_dependencies
    parse_commandline "$@"
    validate_arguments

    # Find all markdown files in the specified directory (support multiple extensions)
    local -a _md_files=()
    local _ext
    for _ext in "${_markdown_extensions[@]}"; do
        local -a _tmp_arr=()
        readarray -d '' -t _tmp_arr < <(find "$_arg_directory" -type f -name "*.$_ext" -print0)
        _md_files+=("${_tmp_arr[@]}")
    done

    if [[ "${#_md_files[@]}" -eq 0 ]]; then
        die "No markdown files found in $_arg_directory" 6
    fi

    # Run is-file-publishable in parallel on all found markdown files
    local -r _xargs_max_procs="${NPROC:-$(getconf _NPROCESSORS_ONLN 2>/dev/null || echo 4)}"
    debug "Using up to $_xargs_max_procs parallel processes for is-file-publishable"
    # TODO Restore skip-file option for missing alias and make custom command here for it
    local -r _xargs_command='file="$1"; is-file-publishable --ignore-publish-state '"$_arg_ignore_publish_state"' --alias-mode '"$_arg_missing_alias"' -- "$file" && printf "%s\0" "$file"'
    debug "xargs command: $_xargs_command"
    local -a _files_to_publish=()
    readarray -d '' -t _files_to_publish < <(printf '%s\0' "${_md_files[@]}" | xargs -0 -n 1 -P "$_xargs_max_procs" bash -c  "$_xargs_command" _)

    debug "Total publishable files found: ${#_files_to_publish[@]}"

    if [[ "${#_files_to_publish[@]}" -eq 0 ]]; then
        printf ''  # Print nothing
    else
        if is_on "$_arg_print0"; then
            printf '%s\0' "${_files_to_publish[@]}"
        else
            printf '%s\n' "${_files_to_publish[@]}"
        fi
    fi
}

main "$@"
